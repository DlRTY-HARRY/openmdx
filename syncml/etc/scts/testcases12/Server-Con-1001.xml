<?xml version="1.0" encoding="UTF-8"?>
<!--
/*******************************************************************

Copyright (c) 2004 Open Mobile Alliance, Ltd.  All Rights Reserved.

This software is made available under the usage and distribution terms 
covered by the Common Public License 1.0 and by using this software you
are bound by the terms and conditions of the same.

EXCEPT AS EXPRESSLY SET FORTH IN THE COMMON PUBLIC LICENSE,
THIS PROGRAM IS PROVIDED ON AN "AS IS" BASIS, 
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, 
EITHER EXPRESS OR IMPLIED INCLUDING, WITHOUT LIMITATION, 
ANY WARRANTIES OR CONDITIONS OF TITLE, NON-INFRINGEMENT, 
MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE.
   
Each recipient is solely responsible for determining the 
appropriateness of using and distributing this program and assumes 
all risks associated with its exercise of rights under the Common 
Public License, including but not limited to the risks and 
costs of program errors, compliance with applicable laws, 
damage to or loss of data, programs or equipment, and 
unavailability or interruption of operations.

********************************************************************/
 -->
<!--SCTSClient can handle the packages recvd across multiple messages -->
<TestCase Id="DS-V1.2-server-con-1001">
    <!--To test if the TestObject handles Multiple messages  properly -->
    <!--Set the MaxMssg size and MaxObject Size to zero  -->
    <SCTSSession>
        <SCTSSet attrib="SCTSMaxMsgSize" param1="5000"/>
        <SCTSSet attrib="TOMaxMsgSize" param1="5000"/>
        <SCTSSet attrib="executionResult" param1="Success"/>
        <SCTSSet attrib="MaxObjSize" param1="0"/>
        <SCTSSet attrib="sessionID" param1="1"/>
        <SCTSSet attrib="msgID" param1="0"/>
        <SCTSOP OP="SCTSDatabase.generateNextAnchor()" return="localNextAnchor"/>
        <!--Add a record in each database to local store the remote device supports -->
        <SCTSSet attrib="DBIndex" param1="1"/>
        <SCTSOP OP="SCTSContext.getNumOfLocalDatabases()" return="NumOfLocalDBs"/>
        <SCTSIf OP="GT" param1="SCTSObject.NumOfLocalDBs" param2="0">
            <SCTSLoop>
                <!--Get the current DB Node -->
                <SCTSOP OP="SCTSContext.getLocalDBLocURI_onIndex()" param1="SCTSObject.DBIndex" return="CurrDBLocURI"/>
                <!--Fetch the Mime Type for the above source -->
                <SCTSOP OP="SCTSContext.getLocalMimeType()" param1="SCTSObject.CurrDBLocURI" return="locMime"/>
                <!--create the Database -->
                <SCTSOP OP="SCTSDatabase.createDB()" param1="SCTSObject.CurrDBLocURI"
                    param2="SCTSObject.locMime" return="CreateStatus"/>
                <!--Fetch the sample data for the current mime type -->
                <SCTSOP OP="SCTSDatabase.getSampleAddData()" param1="SCTSObject.locMime" param2="1" return="SampleData"/>
                <!--Since it is a Client generate LUID -->
                <SCTSOP OP="SCTSDatabase.generateLUID()" return="LUID"/>
                <!--Inser the data to local store  -->
                <SCTSOP OP="SCTSDatabase.insertRawItem()" param1="SCTSObject.CurrDBLocURI"
                    param2="SCTSObject.SampleData" param3="SCTS" param4="SCTSObject.LUID"
                    param5="SCTSNULL" return="InsertStatus"/>
                <!--Fetch the sample data for the current mime type -->
                <SCTSOP OP="SCTSDatabase.getSampleAddData()" param1="SCTSObject.locMime" param2="2" return="SampleData"/>
                <!--Since it is a Client generate LUID -->
                <SCTSOP OP="SCTSDatabase.generateLUID()" return="LUID"/>
                <!--Inser the data to local store  -->
                <SCTSOP OP="SCTSDatabase.insertRawItem()" param1="SCTSObject.CurrDBLocURI"
                    param2="SCTSObject.SampleData" param3="SCTS" param4="SCTSObject.LUID"
                    param5="SCTSNULL" return="InsertStatus"/>
                <SCTSIf OP="EQ" param1="SCTSObject.DBIndex" param2="SCTSObject.NumOfLocalDBs">
                    <!--If v added for all the dbsthen break from the loop -->
                    <SCTSBreak/>
                </SCTSIf>
                <SCTSExpr OP="PLUS" param1="SCTSObject.DBIndex" param2="1" return="DBIndex"/>
            </SCTSLoop>
        </SCTSIf>
        <SCTSLoop>
            <SCTSSend>
                <SyncML xmlns="SYNCML:SYNCML1.2">
                    <SyncHdr>
                        <VerDTD>1.2</VerDTD>
                        <VerProto>SyncML/1.2</VerProto>
                        <SessionID>
                            <SCTSContent>SCTSObject.sessionID</SCTSContent>
                        </SessionID>
                        <MsgID>
                            <SCTSExpr OP="PLUS" param1="msgID" param2="1" return="msgID"/>
                            <SCTSContent>SCTSObject.msgID</SCTSContent>
                        </MsgID>
                        <SCTSOP OP="SCTSContext.getRemoteDeviceAddress()" return="targetID"/>
                        <Target>
                            <LocURI>
                                <SCTSContent>SCTSObject.targetID</SCTSContent>
                            </LocURI>
                        </Target>
                        <Source>
                            <LocURI>
                                <SCTSOP OP="SCTSContext.getLocalDeviceAddress()" return="sourceID"/>
                                <SCTSContent> SCTSObject.sourceID</SCTSContent>
                            </LocURI>
                            <LocName>
                                <SCTSOP OP="SCTSContext.getRemoteDeviceName()" return="sourceName"/>
                                <SCTSContent>SCTSObject.sourceName</SCTSContent>
                            </LocName>
                        </Source>
                        <SCTSExecutePath return="Chal" target="CurrRecv" xpath="/SyncML/SyncBody/Status[CmdID='1']/Chal"/>
                        <!--If there is chal in the curr recv -->
                        <SCTSIf OP="NE" param1="SCTSObject.Chal" param2="SCTSNULL">
                            <!--Send the credentails -->
                            <Cred>
                                <Meta>
                                    <SCTSExecutePath return="authFormat" target="CurrRecv" xpath="/SyncML/SyncBody/Status[CmdID='1']/Chal//Format"/>
                                    <SCTSExecutePath return="authType" target="CurrRecv" xpath="/SyncML/SyncBody/Status[CmdID='1']/Chal//Type"/>
                                    <SCTSExecutePath return="NextNonce" target="CurrRecv" xpath="/SyncML/SyncBody/Status[CmdID='1']/Chal//NextNonce"/>
                                    <SCTSIf OP="EQ" param1="SCTSObject.authFormat" param2="SCTSNULL">
                                        <SCTSSet attrib="authFormat" param1="b64"/>
                                    </SCTSIf>
                                    <Format xmlns="syncml:metinf">
                                        <SCTSContent>SCTSObject.authFormat</SCTSContent>
                                    </Format>
                                    <Type xmlns="syncml:metinf">
                                        <SCTSContent>SCTSObject.authType</SCTSContent>
                                    </Type>
                                </Meta>
                                <SCTSOP OP="SCTSContext.getRemoteCredentials()"
                                    param1="SCTSObject.authType" param2="SCTSObject.NextNonce" return="SCTSCredentials"/>
                                <Data>
                                    <SCTSContent>SCTSObject.SCTSCredentials</SCTSContent>
                                </Data>
                            </Cred>
                        </SCTSIf>
                        <!--Send the Max Mxg size the client can handle -->
                        <SCTSOP OP="SCTSContext.getLocalMaxMsgSize()" return="MaxMsgSize"/>
                        <Meta>
                            <MaxMsgSize xmlns="syncml:metinf">
                                <SCTSContent> SCTSObject.SCTSMaxMsgSize </SCTSContent>
                            </MaxMsgSize>
                        </Meta>
                    </SyncHdr>
                    <SyncBody>
                        <SCTSSet attrib="cmdIDNo" param1="1"/>
                        <SCTSIf OP="NE" param1="SCTSObject.CurrRecv" param2="SCTSNULL">
                            <!--If this is not a first send ..then build the status for curr Recv -->
                            <SCTSExecutePath return="TempMaxMsgSize" target="CurrRecv" xpath="/SyncML/SyncHdr/Meta/MaxMsgSize"/>
                            <SCTSIf OP="NE" param1="SCTSObject.TempMaxMsgSize" param2="SCTSObject.SCTSNULL">
                                <SCTSSet attrib="TOMaxMsgSize" param1="SCTSObject.TempMaxMsgSize"/>
                            </SCTSIf>
                            <Status>
                                <CmdID>
                                    <SCTSContent> SCTSObject.cmdIDNo </SCTSContent>
                                </CmdID>
                                <SCTSExecutePath return="TOMsgID" target="CurrRecv" xpath="/SyncML/SyncHdr/MsgID"/>
                                <MsgRef>
                                    <SCTSContent>SCTSObject.TOMsgID</SCTSContent>
                                </MsgRef>
                                <CmdRef>0</CmdRef>
                                <Cmd>SyncHdr</Cmd>
                                <SCTSExecutePath return="targetID" target="CurrRecv" xpath="/SyncML/SyncHdr/Target/LocURI"/>
                                <TargetRef>
                                    <SCTSContent>SCTSObject.targetID</SCTSContent>
                                </TargetRef>
                                <SCTSExecutePath return="sourceID" target="CurrRecv" xpath="/SyncML/SyncHdr/Source/LocURI"/>
                                <SourceRef>
                                    <SCTSContent> SCTSObject.sourceID </SCTSContent>
                                </SourceRef>
                                <SCTSExecutePath return="Cred" target="CurrRecv" xpath="/SyncML/SyncHdr/Cred"/>
                                <SCTSIf OP="NE" param1="SCTSObject.Cred" param2="SCTSNULL">
                                    <Data>
                                        <SCTSContent> 212 </SCTSContent>
                                    </Data>
                                </SCTSIf>
                                <SCTSIf OP="EQ" param1="SCTSObject.Cred" param2="SCTSNULL">
                                    <Data>
                                        <SCTSContent> 200 </SCTSContent>
                                    </Data>
                                </SCTSIf>
                            </Status>
                        </SCTSIf>
                        <!--Build the alerts for each Database,the Client wants to Sync -->
                        <SCTSSet attrib="DBIndex" param1="0"/>
                        <SCTSOP OP="SCTSContext.getNumOfLocalDatabases()" return="NumOfLocalDBs"/>
                        <SCTSIf OP="GT" param1="SCTSObject.NumOfLocalDBs" param2="0">
                            <SCTSLoop>
                                <SCTSExpr OP="PLUS" param1="SCTSObject.DBIndex" param2="1" return="DBIndex"/>
                                <!--Get the current DB Node -->
                                <SCTSOP OP="SCTSContext.getLocalDBLocURI_onIndex()"
                                    param1="SCTSObject.DBIndex" return="CurrDBLocURI"/>
                                <!--Fetch the matching target for the above source -->
                                <SCTSOP OP="SCTSContext.getLocalMimeType()"
                                    param1="SCTSObject.CurrDBLocURI" return="locMime"/>
                                <SCTSOP OP="SCTSContext.getRemoteDBLocURI_onMime()"
                                    param1="SCTSObject.locMime" return="targetDBLocURI"/>
                                <Alert>
                                    <SCTSExpr OP="PLUS" param1="cmdIDNo" param2="1" return="cmdIDNo"/>
                                    <CmdID>
                                        <SCTSContent>SCTSObject.cmdIDNo</SCTSContent>
                                    </CmdID>
                                    <!--what ever may b force the slow sync -->
                                    <Data> 201</Data>
                                    <Item>
                                        <Source>
                                            <LocURI>
                                                <SCTSContent>SCTSObject.CurrDBLocURI</SCTSContent>
                                            </LocURI>
                                        </Source>
                                        <Target>
                                            <LocURI>
                                                <SCTSContent> SCTSObject.targetDBLocURI</SCTSContent>
                                            </LocURI>
                                        </Target>
                                        <Meta>
                                            <Anchor xmlns="syncml:metinf">
                                                <Next>
                                                  <SCTSContent>SCTSObject.localNextAnchor</SCTSContent>
                                                </Next>
                                            </Anchor>
                                        </Meta>
                                    </Item>
                                </Alert>
                                <SCTSIf OP="EQ" param1="SCTSObject.DBIndex" param2="SCTSObject.NumOfLocalDBs">
                                    <!--If v built sync for all the dbsthen break from the loop -->
                                    <SCTSBreak/>
                                </SCTSIf>
                            </SCTSLoop>
                        </SCTSIf>
                        <Final/>
                    </SyncBody>
                </SyncML>
            </SCTSSend>
            <!--Get the response  -->
            <SCTSRecv/>
            <SCTSExecutePath xpath="/SyncML/SyncHdr/RespURI" return="responseURI" target="CurrRecv"/>
            <SCTSIf param1="SCTSObject.responseURI" param2="SCTSNULL" OP="NE">
                <SCTSOP OP="SCTSContext.setResponseURI()" param1="SCTSObject.responseURI" return="retVal"/>
            </SCTSIf>
            <!--If the status for syncHdr v sent is 212(Authentication accepted) -->
            <SCTSExecutePath return="AuthStatus" target="CurrRecv" xpath="/SyncML/SyncBody/Status[CmdRef='0']/Data"/>
            <SCTSIf OP="EQ" param1="SCTSObject.AuthStatus" param2="212">
                <SCTSBreak/>
            </SCTSIf>
            <SCTSIf OP="EQ" param1="SCTSObject.AuthStatus" param2="200">
                <!-- If the auth status is 200 then v need to send credentials ,if the auth type is md5, then use the recvd nonce for next message credentails -->
                <SCTSIf OP="EQ" param1="SCTSObject.authType" param2="syncml:auth-md5">
                    <SCTSExecutePath return="NextNonce" target="CurrRecv" xpath="/SyncML/SyncBody/Status[CmdRef='0']//NextNonce"/>
                </SCTSIf>
                <SCTSBreak/>
            </SCTSIf>
            <!--Check whether v sent credentials allready -->
            <SCTSExecutePath return="Cred" target="CurrSend" xpath="//Cred"/>
            <SCTSIf OP="NE" param1="SCTSObject.Cred" param2="SCTSNULL">
                <!--status for synchdr is not 212/200 and if v have sent credentials , then it is authentication fail-->
                <SCTSSet attrib="executionResult" param1="AuthenticationFailed"/>
                <SCTSSet attrib="FailureReason" param1="AuthenticationFailed"/>
                <!--So abort the current session -->
                <SCTSExit/>
            </SCTSIf>
        </SCTSLoop>
        <!--Client Sync send -->
        <SCTSSet attrib="ClientDBsIndex" param1="0"/>
        <SCTSSet attrib="ModIndex" param1="1"/>
        <SCTSLoop>
            <SCTSSend>
                <!--Say v ll assume that client sends all modifications in one messgae  -->
                <SyncML xmlns="SYNCML:SYNCML1.2">
                    <SyncHdr>
                        <VerDTD>1.2</VerDTD>
                        <VerProto>SyncML/1.2</VerProto>
                        <SessionID>
                            <SCTSContent>SCTSObject.sessionID</SCTSContent>
                        </SessionID>
                        <MsgID>
                            <SCTSExpr OP="PLUS" param1="msgID" param2="1" return="msgID"/>
                            <SCTSContent>SCTSObject.msgID</SCTSContent>
                        </MsgID>
                        <SCTSOP OP="SCTSContext.getRemoteDeviceAddress()" return="targetID"/>
                        <Target>
                            <LocURI>
                                <SCTSContent>SCTSObject.targetID</SCTSContent>
                            </LocURI>
                        </Target>
                        <Source>
                            <LocURI>
                                <SCTSOP OP="SCTSContext.getLocalDeviceAddress()" return="sourceID"/>
                                <SCTSContent> SCTSObject.sourceID</SCTSContent>
                            </LocURI>
                            <LocName>
                                <SCTSOP OP="SCTSContext.getRemoteDeviceName()" return="sourceName"/>
                                <SCTSContent>SCTSObject.sourceName</SCTSContent>
                            </LocName>
                        </Source>
                        <SCTSIf OP="EQ" param1="SCTSObject.AuthStatus" param2="200">
                            <Cred>
                                <Meta>
                                    <Format xmlns="syncml:metinf">
                                        <SCTSContent>SCTSObject.authFormat</SCTSContent>
                                    </Format>
                                    <Type xmlns="syncml:metinf">
                                        <SCTSContent>SCTSObject.authType</SCTSContent>
                                    </Type>
                                </Meta>
                                <SCTSOP OP="SCTSContext.getRemoteCredentials()"
                                    param1="SCTSObject.authType" param2="SCTSObject.NextNonce" return="SCTSCredentials"/>
                                <Data>
                                    <SCTSContent>SCTSObject.SCTSCredentials</SCTSContent>
                                </Data>
                            </Cred>
                        </SCTSIf>
                    </SyncHdr>
                    <SyncBody>
                        <Status>
                            <SCTSSet attrib="cmdIDNo" param1="1"/>
                            <CmdID>
                                <SCTSContent> SCTSObject.cmdIDNo </SCTSContent>
                            </CmdID>
                            <SCTSExecutePath return="TOMsgID" target="CurrRecv" xpath="/SyncML/SyncHdr/MsgID"/>
                            <MsgRef>
                                <SCTSContent>SCTSObject.TOMsgID</SCTSContent>
                            </MsgRef>
                            <CmdRef>0</CmdRef>
                            <Cmd>SyncHdr</Cmd>
                            <SCTSExecutePath return="targetID" target="CurrRecv" xpath="/SyncML/SyncHdr/Target/LocURI"/>
                            <TargetRef>
                                <SCTSContent>SCTSObject.targetID</SCTSContent>
                            </TargetRef>
                            <SCTSExecutePath return="sourceID" target="CurrRecv" xpath="/SyncML/SyncHdr/Source/LocURI"/>
                            <SourceRef>
                                <SCTSContent> SCTSObject.sourceID </SCTSContent>
                            </SourceRef>
                            <Data>
                                <SCTSContent> 200 </SCTSContent>
                            </Data>
                        </Status>
                        <!--Build the status for alerts recvd -->
                        <SCTSSet attrib="LoopIndex" param1="1"/>
                        <!--Get the number of alerts in the CurrRecv -->
                        <SCTSExecutePath return="NumOfAlerts" target="CurrRecv" xpath="count(/SyncML/SyncBody/Alert)"/>
                        <SCTSIf OP="GT" param1="SCTSObject.NumOfAlerts" param2="0">
                            <SCTSLoop>
                                <SCTSExpr OP="PLUS" param1="/SyncML/SyncBody/Alert["
                                    param2="SCTSObject.LoopIndex" return="xPathQuerry"/>
                                <SCTSExpr OP="PLUS" param1="SCTSObject.xPathQuerry" param2="]" return="xPathQuerry"/>
                                <SCTSExecutePath return="CurrAlert" target="CurrRecv" xpath="SCTSObject.xPathQuerry"/>
                                <!--Fetch the anchors in the recvd alert,since it is slow sync just fetch the Next anchor -->
                                <SCTSExecutePath return="recvdNext" target="CurrAlert" xpath="Item/Meta/Anchor/Next"/>
                                <SCTSExecutePath return="targetID" target="CurrAlert" xpath="Item/Source/LocURI"/>
                                <SCTSOP OP="SCTSDatabase.setRemoteNextAnchor()"
                                    param1="SCTSObject.targetID" param2="SCTSObject.recvdNext" return="status"/>
                                <Status>
                                    <SCTSExpr OP="PLUS" param1="cmdIDNo" param2="1" return="cmdIDNo"/>
                                    <CmdID>
                                        <SCTSContent> SCTSObject.cmdIDNo </SCTSContent>
                                    </CmdID>
                                    <MsgRef>
                                        <SCTSContent>SCTSObject.TOMsgID</SCTSContent>
                                    </MsgRef>
                                    <SCTSExecutePath return="cmdRef" target="CurrAlert" xpath="CmdID"/>
                                    <CmdRef>
                                        <SCTSContent> SCTSObject.cmdRef </SCTSContent>
                                    </CmdRef>
                                    <Cmd>Alert</Cmd>
                                    <SCTSExecutePath return="targetID" target="CurrAlert" xpath="Item/Target/LocURI"/>
                                    <TargetRef>
                                        <SCTSContent>SCTSObject.targetID</SCTSContent>
                                    </TargetRef>
                                    <SCTSExecutePath return="sourceID" target="CurrAlert" xpath="Item/Source/LocURI"/>
                                    <SourceRef>
                                        <SCTSContent> SCTSObject.sourceID </SCTSContent>
                                    </SourceRef>
                                    <Data>
                                        <SCTSContent>200</SCTSContent>
                                    </Data>
                                    <Item>
                                        <Data>
                                            <Anchor xmlns="syncml:metinf">
                                                <Next>
                                                  <SCTSContent> SCTSObject.recvdNext </SCTSContent>
                                                </Next>
                                            </Anchor>
                                        </Data>
                                    </Item>
                                </Status>
                                <SCTSIf OP="EQ" param1="SCTSObject.LoopIndex" param2="SCTSObject.NumOfAlerts">
                                    <SCTSBreak/>
                                </SCTSIf>
                                <SCTSExpr OP="PLUS" param1="SCTSObject.LoopIndex" param2="1" return="LoopIndex"/>
                            </SCTSLoop>
                        </SCTSIf>
                        <!--#################################################################### -->
                        <!-- If the Package 3 is run into multiple meassages ..then v may recv status for ADD in the CurrRecv..as
                    response to earlier message of package#3 -->
                        <!--For all sync Nodes in the prev send ..check wether v sent any adds..so for the testcase to pass v must recv ststus 
                   201 each ADD-->
                        <!-- Check  weather v sent sync in the prev send-->
                        <SCTSSet attrib="LoopIndex" param1="1"/>
                        <SCTSExecutePath return="NumOfSyncs" target="PrevSend" xpath="count(/SyncML/SyncBody/Sync)"/>
                        <SCTSIf OP="GT" param1="SCTSObject.NumOfSyncs" param2="0">
                            <SCTSLoop>
                                <!--Get the cuurrent SyncNode -->
                                <SCTSExpr OP="PLUS" param1="/SyncML/SyncBody/Sync["
                                    param2="SCTSObject.LoopIndex" return="xPathQuerry"/>
                                <SCTSExpr OP="PLUS" param1="SCTSObject.xPathQuerry" param2="]" return="xPathQuerry"/>
                                <SCTSExecutePath return="CurrSync" target="PrevSend" xpath="SCTSObject.xPathQuerry"/>
                                <!--get the targret uri -->
                                <SCTSExecutePath return="CurrDBLocURI" target="CurrSync" xpath="Target/LocURI"/>
                                <!--Check weatehr v sent any adds as part of this current sync -->
                                <SCTSExecutePath return="NumOfAdds" target="CurrSync" xpath="count(Add)"/>
                                <SCTSIf OP="GT" param1="SCTSObject.NumOfAdds" param2="0">
                                    <SCTSSet attrib="InnerLoopIndex" param1="1"/>
                                    <SCTSLoop>
                                        <!--Get the cuurrent AddNode -->
                                        <SCTSExpr OP="PLUS" param1="Add["
                                            param2="SCTSObject.InnerLoopIndex" return="xPathQuerry"/>
                                        <SCTSExpr OP="PLUS" param1="SCTSObject.xPathQuerry"
                                            param2="]" return="xPathQuerry"/>
                                        <SCTSExecutePath return="CurrAdd" target="CurrSync" xpath="SCTSObject.xPathQuerry"/>
                                        <!--Check for the status recvd  -->
                                        <SCTSExecutePath return="sendCmdID" target="CurrAdd" xpath="CmdID"/>
                                        <SCTSExpr OP="PLUS" param1="/SyncML/SyncBody/Status[CmdRef="
                                            param2="SCTSObject.sendCmdID" return="xpathString"/>
                                        <SCTSExpr OP="PLUS" param1="SCTSObject.xpathString"
                                            param2="]/Data" return="xpathString"/>
                                        <SCTSExecutePath return="statusVal" target="CurrRecv" xpath="SCTSObject.xpathString"/>
                                        <SCTSIf OP="NE" param1="SCTSObject.statusVal" param2="201">
                                            <SCTSSet attrib="executionResult" param1="Failed"/>
                                            <SCTSSet attrib="FailureReason" param1="Unexpected Status for Add"/>
                                        </SCTSIf>
                                        <SCTSIf OP="EQ" param1="SCTSObject.InnerLoopIndex" param2="SCTSObject.NumOfAdds">
                                            <SCTSBreak/>
                                        </SCTSIf>
                                        <SCTSExpr OP="PLUS" param1="SCTSObject.InnerLoopIndex"
                                            param2="1" return="InnerLoopIndex"/>
                                    </SCTSLoop>
                                </SCTSIf>
                                <SCTSIf OP="EQ" param1="SCTSObject.LoopIndex" param2="SCTSObject.NumOfSyncs">
                                    <SCTSBreak/>
                                </SCTSIf>
                                <SCTSExpr OP="PLUS" param1="SCTSObject.LoopIndex" param2="1" return="LoopIndex"/>
                            </SCTSLoop>
                        </SCTSIf>
                        <!--***************************************************************************************************** -->
                        <!--Build the sync for each database the SCTS supports -->
                        <SCTSOP OP="SCTSContext.getNumOfLocalDatabases()" return="NumOfLocalDBs"/>
                        <SCTSIf OP="GT" param1="SCTSObject.NumOfLocalDBs" param2="0">
                            <!--Check wether next sync fits or not -->
                            <SCTSExecutePath return="CurrentSize" target="CurrSend" xpath="string-length(/SyncML)"/>
                            <!--25 bytes as to b reserved for </Final></SynaBody><SyncML> -->
                            <SCTSExpr OP="PLUS" param1="SCTSObject.CurrentSize" param2="25" return="tempSize"/>
                            <!--Say the size of next sync appr 200 bytes -->
                            <SCTSExpr OP="PLUS" param1="SCTSObject.tempSize" param2="200" return="syncTempSize"/>
                            <!--If the current sync unable to fit in then break from the loop -->
                            <SCTSIf OP="GT" param1="SCTSObject.syncTempSize" param2="SCTSObject.MaxMsgSize">
                                <SCTSBreak/>
                            </SCTSIf>
                            <!--Get the current DB Node -->
                            <SCTSExpr OP="PLUS" param1="SCTSObject.ClientDBsIndex" param2="1" return="TempClientDBsIndex"/>
                            <SCTSOP OP="SCTSContext.getLocalDBLocURI_onIndex()"
                                param1="SCTSObject.TempClientDBsIndex" return="CurrDBLocURI"/>
                            <Sync>
                                <SCTSExpr OP="PLUS" param1="cmdIDNo" param2="1" return="cmdIDNo"/>
                                <CmdID>
                                    <SCTSContent>SCTSObject.cmdIDNo</SCTSContent>
                                </CmdID>
                                <Source>
                                    <LocURI>
                                        <SCTSContent>SCTSObject.CurrDBLocURI</SCTSContent>
                                    </LocURI>
                                </Source>
                                <!--Fetch the matching target for the above source -->
                                <SCTSOP OP="SCTSContext.getLocalMimeType()"
                                    param1="SCTSObject.CurrDBLocURI" return="locMime"/>
                                <SCTSOP OP="SCTSContext.getRemoteDBLocURI_onMime()"
                                    param1="SCTSObject.locMime" return="targetID"/>
                                <Target>
                                    <LocURI>
                                        <SCTSContent>SCTSObject.targetID</SCTSContent>
                                    </LocURI>
                                </Target>
                                <SCTSOP OP="SCTSDatabase.getNumberOfModifications() "
                                    param1="SCTSObject.CurrDBLocURI" param2="Add" return="NumOfAdds"/>
                                <SCTSIf param1="SCTSObject.NumOfAdds" param2="0" OP="GT">
                                    <!--Get the modification list -->
                                    <!--Fetch the current add  -->
                                    <SCTSOP OP="SCTSDatabase.getModificationOnIndex()"
                                        param1="SCTSObject.CurrDBLocURI" param2="Add"
                                        param3="SCTSObject.ModIndex" return="CurrAdd"/>
                                    <!--Find the size of the add -->
                                    <SCTSExecutePath xpath="string-length(DBRecord)"
                                        target="CurrAdd" return="AddSize"/>
                                    <SCTSExpr param1="SCTSObject.syncTempSize"
                                        param2="SCTSObject.AddSize" return="TotalMsgSize" OP="PLUS"/>
                                    <!--If the  current add  fits in-->
                                    <SCTSIf param1="SCTSObject.TotalMsgSize"
                                        param2="SCTSObject.MaxMsgSize" OP="LT">
                                        <Add>
                                            <SCTSExpr OP="PLUS" param1="cmdIDNo" param2="1" return="cmdIDNo"/>
                                            <CmdID>
                                                <SCTSContent> SCTSObject.cmdIDNo </SCTSContent>
                                            </CmdID>
                                            <Meta>
                                                <Type xmlns="syncml:metinf">
                                                  <SCTSContent>SCTSObject.locMime</SCTSContent>
                                                </Type>
                                            </Meta>
                                            <Item>
                                                <Source>
                                                  <SCTSExecutePath return="LUID" target="CurrAdd" xpath="DBLUID"/>
                                                  <LocURI>
                                                  <SCTSContent>SCTSObject.LUID</SCTSContent>
                                                  </LocURI>
                                                </Source>
                                                <SCTSExecutePath return="data" target="CurrAdd" xpath="DBData"/>
                                                <Data>
                                                  <SCTSContent>SCTSObject.data</SCTSContent>
                                                </Data>
                                            </Item>
                                        </Add>
                                    </SCTSIf>
                                    <SCTSIf param1="SCTSObject.ModIndex"
                                        param2="SCTSObject.NumOfAdds" OP="EQ">
                                        <SCTSSet attrib="ModIndex" param1="0"/>
                                        <SCTSExpr param1="SCTSObject.ClientDBsIndex" param2="1"
                                            return="ClientDBsIndex" OP="PLUS"/>
                                    </SCTSIf>
                                    <SCTSExpr param1="SCTSObject.ModIndex" param2="1"
                                        return="ModIndex" OP="PLUS"/>
                                </SCTSIf>
                                <!--If there is no modifictions to send then move to next sync -->
                                <SCTSIf param1="SCTSObject.NumOfAdds" param2="0" OP="EQ">
                                    <SCTSExpr param1="SCTSObject.ClientDBsIndex" param2="1"
                                        return="ClientDBsIndex" OP="PLUS"/>
                                </SCTSIf>
                            </Sync>
                        </SCTSIf>
                        <!--***************************************************************************************************** -->
                        <!--If v r able to send sync command for all dbs client support then end the package #4 -->
                        <SCTSIf OP="EQ" param1="SCTSObject.ClientDBsIndex" param2="SCTSObject.NumOfLocalDBs">
                            <Final/>
                        </SCTSIf>
                    </SyncBody>
                </SyncML>
            </SCTSSend>
            <SCTSExecutePath return="Final" target="CurrSend" xpath="/SyncML/SyncBody/Final"/>
            <SCTSBreak/>
        </SCTSLoop>
        <!--ServerSync Send -->
        <SCTSLoop>
            <!--The below recv(package #4) ...ll have status for modificatins sent in prev send(package #3) ...and modifications from server(Modifications may run across multiple messges) -->
            <SCTSRecv/>
            <SCTSExecutePath xpath="/SyncML/SyncHdr/RespURI" return="responseURI" target="CurrRecv"/>
            <SCTSIf param1="SCTSObject.responseURI" param2="SCTSNULL" OP="NE">
                <SCTSOP OP="SCTSContext.setResponseURI()" param1="SCTSObject.responseURI" return="retVal"/>
            </SCTSIf>
            <SCTSIf OP="EQ" param1="SCTSObject.AuthStatus" param2="200">
                <!-- If the auth status is 200 then v need to send credentials ,if the auth type is md5, then use the recvd nonce for next message credentails -->
                <SCTSIf OP="EQ" param1="SCTSObject.authType" param2="syncml:auth-md5">
                    <SCTSExecutePath return="NextNonce" target="CurrRecv" xpath="/SyncML/SyncBody/Status[CmdRef='0']//NextNonce"/>
                </SCTSIf>
            </SCTSIf>
            <!--In the next send Build the status for adds and send Maps for completly recvd adds -->
            <SCTSSend>
                <SyncML xmlns="SYNCML:SYNCML1.2">
                    <SyncHdr>
                        <VerDTD>1.2</VerDTD>
                        <VerProto>SyncML/1.2</VerProto>
                        <SessionID>
                            <SCTSContent>SCTSObject.sessionID</SCTSContent>
                        </SessionID>
                        <MsgID>
                            <SCTSExpr OP="PLUS" param1="msgID" param2="1" return="msgID"/>
                            <SCTSContent>SCTSObject.msgID</SCTSContent>
                        </MsgID>
                        <SCTSOP OP="SCTSContext.getRemoteDeviceAddress()" return="targetID"/>
                        <Target>
                            <LocURI>
                                <SCTSContent>SCTSObject.targetID</SCTSContent>
                            </LocURI>
                        </Target>
                        <Source>
                            <LocURI>
                                <SCTSOP OP="SCTSContext.getLocalDeviceAddress()" return="sourceID"/>
                                <SCTSContent> SCTSObject.sourceID</SCTSContent>
                            </LocURI>
                            <LocName>
                                <SCTSOP OP="SCTSContext.getRemoteDeviceName()" return="sourceName"/>
                                <SCTSContent>SCTSObject.sourceName</SCTSContent>
                            </LocName>
                        </Source>
                        <SCTSIf OP="EQ" param1="SCTSObject.AuthStatus" param2="200">
                            <Cred>
                                <Meta>
                                    <Format xmlns="syncml:metinf">
                                        <SCTSContent>SCTSObject.authFormat</SCTSContent>
                                    </Format>
                                    <Type xmlns="syncml:metinf">
                                        <SCTSContent>SCTSObject.authType</SCTSContent>
                                    </Type>
                                </Meta>
                                <SCTSOP OP="SCTSContext.getRemoteCredentials()"
                                    param1="SCTSObject.authType" param2="SCTSObject.NextNonce" return="SCTSCredentials"/>
                                <Data>
                                    <SCTSContent>SCTSObject.SCTSCredentials</SCTSContent>
                                </Data>
                            </Cred>
                        </SCTSIf>
                    </SyncHdr>
                    <SyncBody>
                        <Status>
                            <SCTSSet attrib="cmdIDNo" param1="1"/>
                            <CmdID>
                                <SCTSContent> SCTSObject.cmdIDNo </SCTSContent>
                            </CmdID>
                            <SCTSExecutePath return="TOMsgID" target="CurrRecv" xpath="/SyncML/SyncHdr/MsgID"/>
                            <MsgRef>
                                <SCTSContent>SCTSObject.TOMsgID</SCTSContent>
                            </MsgRef>
                            <CmdRef>0</CmdRef>
                            <Cmd>SyncHdr</Cmd>
                            <SCTSExecutePath return="targetID" target="CurrRecv" xpath="/SyncML/SyncHdr/Target/LocURI"/>
                            <TargetRef>
                                <SCTSContent>SCTSObject.targetID</SCTSContent>
                            </TargetRef>
                            <SCTSExecutePath return="sourceID" target="CurrRecv" xpath="/SyncML/SyncHdr/Source/LocURI"/>
                            <SourceRef>
                                <SCTSContent> SCTSObject.sourceID </SCTSContent>
                            </SourceRef>
                            <Data>
                                <SCTSContent> 200 </SCTSContent>
                            </Data>
                        </Status>
                        <SCTSSet attrib="LoopIndex" param1="1"/>
                        <SCTSExecutePath return="NumOfSyncs" target="PrevSend" xpath="count(/SyncML/SyncBody/Sync)"/>
                        <SCTSIf OP="GT" param1="SCTSObject.NumOfSyncs" param2="0">
                            <SCTSIf OP="EQ" param1="SCTSObject.executionResult" param2="Success">
                                <SCTSLoop>
                                    <!--Get the cuurrent SyncNode -->
                                    <SCTSExpr OP="PLUS" param1="/SyncML/SyncBody/Sync["
                                        param2="SCTSObject.LoopIndex" return="xPathQuerry"/>
                                    <SCTSExpr OP="PLUS" param1="SCTSObject.xPathQuerry" param2="]" return="xPathQuerry"/>
                                    <SCTSExecutePath return="CurrSync" target="PrevSend" xpath="SCTSObject.xPathQuerry"/>
                                    <!--get the targret uri -->
                                    <SCTSExecutePath return="CurrDBLocURI" target="CurrSync" xpath="Target/LocURI"/>
                                    <!--Check weatehr v sent any adds as part of this current sync -->
                                    <SCTSExecutePath return="NumOfAdds" target="CurrSync" xpath="count(Add)"/>
                                    <SCTSIf OP="GT" param1="SCTSObject.NumOfAdds" param2="0">
                                        <SCTSSet attrib="InnerLoopIndex" param1="1"/>
                                        <SCTSLoop>
                                            <!--Get the cuurrent AddNode -->
                                            <SCTSExpr OP="PLUS" param1="Add["
                                                param2="SCTSObject.InnerLoopIndex" return="xPathQuerry"/>
                                            <SCTSExpr OP="PLUS" param1="SCTSObject.xPathQuerry"
                                                param2="]" return="xPathQuerry"/>
                                            <SCTSExecutePath return="CurrAdd" target="CurrSync" xpath="SCTSObject.xPathQuerry"/>
                                            <!--Check for the status recvd  -->
                                            <SCTSExecutePath return="sendCmdID" target="CurrAdd" xpath="CmdID"/>
                                            <SCTSExpr OP="PLUS"
                                                param1="/SyncML/SyncBody/Status[CmdRef="
                                                param2="SCTSObject.sendCmdID" return="xpathString"/>
                                            <SCTSExpr OP="PLUS" param1="SCTSObject.xpathString"
                                                param2="]/Data" return="xpathString"/>
                                            <SCTSExecutePath return="statusVal" target="CurrRecv" xpath="SCTSObject.xpathString"/>
                                            <SCTSIf OP="NE" param1="SCTSObject.statusVal" param2="201">
                                                <SCTSSet attrib="executionResult" param1="Failed"/>
                                                <SCTSSet attrib="FailureReason" param1="Unexpected Status for Add"/>
                                            </SCTSIf>
                                            <SCTSIf OP="EQ" param1="SCTSObject.InnerLoopIndex" param2="SCTSObject.NumOfAdds">
                                                <SCTSBreak/>
                                            </SCTSIf>
                                            <SCTSExpr OP="PLUS" param1="SCTSObject.InnerLoopIndex"
                                                param2="1" return="InnerLoopIndex"/>
                                        </SCTSLoop>
                                    </SCTSIf>
                                    <SCTSIf OP="EQ" param1="SCTSObject.LoopIndex" param2="SCTSObject.NumOfSyncs">
                                        <SCTSBreak/>
                                    </SCTSIf>
                                    <SCTSExpr OP="PLUS" param1="SCTSObject.LoopIndex" param2="1" return="LoopIndex"/>
                                </SCTSLoop>
                            </SCTSIf>
                        </SCTSIf>
                        <!--Build the status for each sync recvd from server  -->
                        <SCTSSet attrib="LoopIndex" param1="1"/>
                        <SCTSExecutePath return="NumOfSyncs" target="CurrRecv" xpath="count(/SyncML/SyncBody/Sync)"/>
                        <SCTSIf OP="GT" param1="SCTSObject.NumOfSyncs" param2="0">
                            <SCTSLoop>
                                <!--Get the cuurrent SyncNode -->
                                <SCTSExpr OP="PLUS" param1="/SyncML/SyncBody/Sync["
                                    param2="SCTSObject.LoopIndex" return="xPathQuerry"/>
                                <SCTSExpr OP="PLUS" param1="SCTSObject.xPathQuerry" param2="]" return="xPathQuerry"/>
                                <SCTSExecutePath return="CurrSync" target="CurrRecv" xpath="SCTSObject.xPathQuerry"/>
                                <Status>
                                    <SCTSExpr OP="PLUS" param1="cmdIDNo" param2="1" return="cmdIDNo"/>
                                    <CmdID>
                                        <SCTSContent>SCTSObject.cmdIDNo</SCTSContent>
                                    </CmdID>
                                    <MsgRef>
                                        <SCTSContent>SCTSObject.TOMsgID</SCTSContent>
                                    </MsgRef>
                                    <SCTSExecutePath return="cmdRef" target="CurrSync" xpath="CmdID"/>
                                    <CmdRef>
                                        <SCTSContent>SCTSObject.cmdRef</SCTSContent>
                                    </CmdRef>
                                    <Cmd>Sync</Cmd>
                                    <SCTSExecutePath return="TargetDB" target="CurrSync" xpath="Target/LocURI"/>
                                    <SCTSExecutePath return="SourceDB" target="CurrSync" xpath="Source/LocURI"/>
                                    <TargetRef>
                                        <SCTSContent>SCTSObject.TargetDB</SCTSContent>
                                    </TargetRef>
                                    <SourceRef>
                                        <SCTSContent>SCTSObject.SourceDB</SCTSContent>
                                    </SourceRef>
                                    <Data>200</Data>
                                </Status>
                                <SCTSIf OP="EQ" param1="SCTSObject.LoopIndex" param2="SCTSObject.NumOfSyncs">
                                    <SCTSBreak/>
                                </SCTSIf>
                                <SCTSExpr OP="PLUS" param1="SCTSObject.LoopIndex" param2="1" return="LoopIndex"/>
                            </SCTSLoop>
                        </SCTSIf>
                        <!--Check whether v recvd Final in the prev recv. If there is Final ...it shows the end of package #4...ao v can end this current package #6 -->
                        <SCTSExecutePath return="Final" target="CurrRecv" xpath="/SyncML/SyncBody/Final"/>
                        <SCTSIf OP="NE" param1="SCTSObject.Final" param2="SCTSNULL">
                            <!--If there if Final end the package#5 -->
                            <Final/>
                        </SCTSIf>
                    </SyncBody>
                </SyncML>
            </SCTSSend>
            <!-- here v have to decide whether goto recieving package #6 or loop bk to another message of package #5:Itz ll depends on final in the prev Recv-->
            <SCTSExecutePath return="Final" target="CurrRecv" xpath="/SyncML/SyncBody/Final"/>
            <SCTSBreak/>
        </SCTSLoop>
        <!--So if there is final(or end of package #4 and hence #5) recv the next package #6 -; package #6 ll have status for Maps sent in package #5 -->
        <SCTSRecv/>
        <SCTSExecutePath xpath="/SyncML/SyncHdr/RespURI" return="responseURI" target="CurrRecv"/>
        <SCTSIf param1="SCTSObject.responseURI" param2="SCTSNULL" OP="NE">
            <SCTSOP OP="SCTSContext.setResponseURI()" param1="SCTSObject.responseURI" return="retVal"/>
        </SCTSIf>
    </SCTSSession>
</TestCase>
